name: publish-n-release

on:
    workflow_run:
        workflows: ['checks']
        types: [completed]
        branches:
            - main

permissions:
    contents: write
    id-token: write
    pull-requests: write

jobs:
    dry-run-npm:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: Setup pnpm
              uses: pnpm/action-setup@v4
            - name: Setup Node.js
              run: pnpm install --frozen-lockfile
            - name: Publish package (dry run)
              run: pnpm publish --dry-run --no-git-checks

    dry-run-jsr:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - uses: pnpm/action-setup@v4
            - run: pnpm install --frozen-lockfile
            - uses: denoland/setup-deno@v2
              with:
                  deno-version: 2.6.8
            - name: Deno publish dry run
              uses: ./.github/actions/deno-publish-all
              with:
                  search-root: packages
                  dry-run: 'true'

    npm-publish:
        needs: [dry-run-npm]
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
            pull-requests: write
            actions: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: Turbo cache
              uses: ./.github/actions/turbo-cache
              with:
                  turbo_token: ${{ secrets.TURBO_TOKEN }}
                  turbo_team: ${{ vars.TURBO_TEAM }}
                  enable_fallback_cache: 'true'

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 24.13.0
                  cache: pnpm
                  registry-url: https://registry.npmjs.org

            - name: Update npm to latest
              run: npm i -g npm@latest
            - name: Check Node.js and npm versions
              run: node -v && npm -v
            - name: Check npm registry and ping
              run: npm config get registry && npm ping
            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Determine release metadata
              id: release_meta
              uses: ./.github/actions/release-metadata

            - name: Run prepublishOnly script
              run: pnpm run prepublishOnly

            - name: Run changesets
              id: changesets
              uses: changesets/action@v1
              with:
                  publish: pnpm run release
                  commit: 'chore: merge changesets'
                  title: ${{ steps.release_meta.outputs.title }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  HUSKY: 0

            - name: Trigger sync-deno-version workflow on release branch
              if: ${{ steps.changesets.outputs.hasChangesets == 'true' }}
              uses: ./.github/actions/sync-deno
              with:
                  release_branch: changeset-release/${{ github.event.workflow_run.head_branch }}
                  workflow_file: sync-deno-version.yml
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    jsr-publish:
        needs: [dry-run-jsr]
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        timeout-minutes: 30
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: Setup pnpm
              uses: pnpm/action-setup@v4
            - name: Install dependencies
              run: pnpm install --frozen-lockfile
            - name: Setup Deno
              uses: denoland/setup-deno@v2
              with:
                  deno-version: 2.6.8
                  cache: true
            - name: Publish to JSR
              uses: ./.github/actions/deno-publish-all
              with:
                  search-root: packages
